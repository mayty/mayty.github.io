<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//RU">
<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
<META HTTP-EQUIV="Content-Language" CONTENT="ru">

<title>Лекция</title>
<style type="text/css">
 body {font-family: Arial, sans-serif;}
 .c {font-family: "Courier New", Courier, monospace}
</style>

</HEAD><BODY>

<div align="justify">

<p>&nbsp;</p>
<div align="center">
<p><strong>МНОГОПРОТОКОЛЬНАЯ КОММУТАЦИЯ НА ОСНОВЕ МЕТОК</strong></p>
</div>
<p>&nbsp;</p>

<p>Традиционная IP-маршрутизация обладает некоторыми особенностями, которые, при оценке производительности СПД, можно считать ее основными «слабыми местами»:<br>
1.&nbsp;Для автоматического поиска и распространения в СПД маршрутной информации требуются специальные протоколы -- протоколы динамической маршрутизации.<br>
2.&nbsp;В процессе маршрутизации анализируется только IP-адрес назначения из заголовка IP-пакета.<br>
3.&nbsp;При пересылке пакета по СПД на каждой из задействованных станций происходит обращение к таблице маршрутизации, что требует определенных временных затрат.</p>

<p><em>Многопротокольная коммутация на основе меток</em> -- MultiProtocol Label Switching (MPLS) (RFC&nbsp;3031 и RFC&nbsp;3032) является альтернативой традиционной маршрутизации, которая позволяет ускорить продвижение пакетов по СПД за счет определенных ухищрений.</p>

<p>Стоит упомянуть еще одно, часто важное, функциональное ограничение даже самых совершенных из имеющихся в настоящее время реализаций систем традиционной IP-маршрутизации -- нет легко масштабируемой возможности пересылать трафик по нескольким неравноценным маршрутам. С помощью технологии MPLS решается и эта задача.</p>

<p>Идея MPLS заключается во внесении в пакеты специальных меток (MPLS labels), отражающих правильное направление, и ретрансляции на основе анализа этих меток. Временной выигрыш достигается за счет того, что при ретрансляции помеченных пакетов они «не поднимаются» до третьего уровня.</p>

<div align="center">
<img src="lk08.01.bmp">
<br>
Рисунок -- MPLS-метки в Ethernet-кадре
</div>

<p>Поля:<br>
1.&nbsp;Label (Label Value) -- собственно значение метки.<br>
2.&nbsp;Exp (Experimental Use) -- экспериментальное использование (на практике связано с QoS).<br>
3.&nbsp;S (Bottom of Stack) -- признак дна стека из меток (то есть последней метки в стеке).<br>
4.&nbsp;TTL (Time to Live) -- время жизни помеченного пакета (имеет тот же смысл, что и IP TTL; в случае с IP-инкапсуляцией должно совпадать с IP TTL).</p>

<p>О наличии меток в пакете говорит значение поля Length/Type заголовка кадра, то есть заголовка второго уровня:<br>
--&nbsp;0800h -- IP (в пакете нет меток);<br>
--&nbsp;86DDh -- IPv6 (в пакете нет меток);<br>
--&nbsp;8847h -- MPLS Unicast (в пакете есть метки);<br>
--&nbsp;8848h -- MPLS Multicast (в пакете есть метки).</p>

<p>Технология MPLS поддерживает не только IP, а и другие протоколы третьего уровня.</p>

<p>По сути, метка представляет собой число, которое вставляется между заголовками второго и третьего уровней (поэтому метка часто называется заголовком L2.5).</p>

<p>Описанные преобразования соответствуют наиболее часто используемому режиму работы (frame-mode MPLS) и происходят применительно почти ко всем поддерживаемым средам (например, Ethernet). Но, в случае транспортировки по ATM-домену, используется специальный режим (cell-mode MPLS), причем в качестве метки используется пара VPI/VCI из заголовка ячейки.</p>

<p>В рядовой ситуации в пакете содержится только одна метка, но может быть и больше.</p>

<p>В стандарт MPLS заложена поддержка MPLS-иерархии, хотя фактически применяются только два варианта такой иерархии (оба с двумя уровнями):<br>
1 MPLS Traffic Engineering -- построение туннелей с привлечением возможностей протокола RSVP.<br>
2 MPLS VPNs -- организация работы виртуальных частных сетей с привлечением возможностей протокола BGP.</p>

<p>В общем случае метки образуют стек. Внесение еще одной метки равносильно операции «push», изъятие -- «pop». При текущей ретрансляции пакета всегда обрабатывается метка, находящаяся на вершине стека, то есть расположенная ближе всего к заголовку.</p>

<p>К важным достоинствам MPLS относится то, что метки могут генерироваться с учетом различных критериев, например QoS.</p>

<p>Значения меток от 0 до 15 зарезервированы.</p>

<p>Функционал MPLS возлагается именно на маршрутизаторы. Маршрутизаторы с поддержкой MPLS известны как LSRs (Label Switching Routers). В cell-mode MPLS роль внутренних LSRs играют ATM-коммутаторы.</p>

<div align="center">
<img src="lk08.02.jpg">
<br>
Рисунок -- Структура МPLS-домена
</div>

<p>MPLS-домен (MPLS Domain) состоит из некоторого количества связанных между собой LSRs. При правильной организации, MPLS-домен строится на базе некоторой цельной СПД, то есть подразумевается, что все входящие в MPLS-домен устройства предназначены только для транспортировки, а не для потребления пользовательских данных. Граничные LSRs (Edge LSRs) ответственны за первоначальное внесение меток при попадании транзитных пакетов в MPLS-домен и окончательное изъятие меток, когда транзитные пакеты покидают MPLS-домен. Внутренние LSRs (Core LSRs) являются основными рабочими компонентами MPLS-домена, которые непосредственно быстро коммутируют пакеты. Все LSRs в пределах одного MPLS-домена оперируют метками одного уровня иерархии.</p>

<p>Для обеспечения правильного понимания работы LSR требуется описание входящих в структуру LSR подсистем и связей между этими подсистемами.</p>

<div align="center">
<img src="lk08.03.bmp">
<br>
Рисунок -- Структура LSR
</div>

<p>В процессе принятия решения о том, куда и как передавать IP-пакет, задействуются следующие таблицы:<br>
1.&nbsp;IP Routing Table (RT) -- традиционная таблица IP-маршрутизации.<br>
2.&nbsp;Label Table -- таблица меток -- фактически информационная база о метках, в терминологии MPLS называемая LIB (Label Information Base).<br>
3.&nbsp;IP Forwarding Table -- таблица ретрансляции IP-пакетов -- обособленно (от таблицы маршрутизации) выделяемая при рассмотрении MPLS подсистема, содержащая в себе отражение таблицы маршрутизации с некоторыми усовершенствованиями и дополнениями, непосредственно задействуемая для ретрансляции непомеченных пакетов и называемая FIB (Forwarding Information Base).<br>
4.&nbsp;Label Forwarding Table -- собственно таблица коммутации на основе меток -- предназначенная для ретрансляции помеченных пакетов информационная база, называемая LFIB (Label Forwarding Information Base).</p>

<p>Архитектура MPLS включает два плана:<br>
1.&nbsp;MPLS Control Plane -- регламентирован обмен маршрутной информацией с помощью протоколов динамической маршрутизации и обмен информацией о метках.<br>
2.&nbsp;MPLS Data Plane (Forwarding Plane) -- регламентирован процесс ретрансляции пакетов на основе меток.</p>

<p>Реализовать обмен информацией о метках возможно двумя способами:<br>
1.&nbsp;Расширить функционал уже имеющихся протоколов динамической маршрутизации.<br>
2.&nbsp;Разработать новые протоколы.</p>

<p>Был выбран второй путь, так как он намного проще. В результате появились LDP (Label Distribution Protocol) (RFC&nbsp;5036) и TDP (Tag Distribution Protocol). Второй протокол является проприетарным протоколом Cisco с аналогичной, в сравнении с первым, функциональностью.</p>

<p>Алгоритм работы MPLS-домена в стандарте определен неоднозначно. Применительно к типичной реализации frame-mode MPLS он выглядит следующим образом.</p>

<p>В первую очередь в MPLS-домене отрабатывает один из протоколов динамической маршрутизации, например OSPF (должен относиться к группе IGP). Ситуация, когда маршруты ко всем целевым подсетям найдены, то есть с точки зрения обычной динамической маршрутизации MPLS-домен перешел в устойчивое состояние, является великолепной предпосылкой для начала процесса генерации и распространения меток.</p>

<p>После включения MPLS на LSR, на нем, применительно к каждому динамическому маршруту из RT, генерируется уникальная локальная метка (local label), которая ставится в соответствие полю Destination.</p>

<p>Затем сгенерированная метка, в связке с подсетью, передается всем соседним LSRs по протоколу LDP либо TDP. Этой меткой нужно будет метить пакеты, адресованные соответствующей подсети, при их передаче данному LSR. Для передачи сообщения-обновления о сгенерированной метке (LDP Update либо TDP Update) активный LSR устанавливает TCP-соединение (порт 646 -- LDP, порт 711 -- TDP). Это действие никак не синхронизируется с другими активными LSRs, то есть очевидно, что возникает MPLS-конвергенция.</p>

<p>С течением времени в LIB каждого LSR постепенно заносятся все получаемые от соседних LSRs метки. В результате, в LIB будет содержаться множество меток, привязанных к совершенно неправильным направлениям. Это делается «на опережение» -- накопленная информация о связях будет использована для ускорения повторной MPLS-конвергенции при топологических изменениях. А вот привязанные к единственным заведомо правильным в текущий момент направлениям ретрансляционные метки (next-hop labels) принимаются от следующих в звене LSRs (next-hop LSRs). Следующие в звене LSRs определяются по RT (шлюзы в IP-маршрутах). Таковые метки заносятся в качестве дополнений к соответствующим маршрутам в FIB и в качестве рабочих меток в LFIB.</p>

<p>В конце концов, к каждой из целевых подсетей выстраивается цепь, называемая LSP (Label-Switched Path). Все информационные пакеты, проходящие по одному и тому же LSP соответствуют одному классу, называемому FEC (Forwarding Equivalence Class). Получается, что направление пересылки информационных пакетов (downstream) противоположно направлению передачи ретрансляционных меток (upstream).</p>

<p>Для непосредственной ретрансляции пакетов задействуются две таблицы: FIB и LFIB. При этом возможны ситуации:<br>
--&nbsp;если принят непомеченный пакет и для него найдена несодержащая метку запись в FIB, то пакет передается непомеченным;<br>
--&nbsp;если принят непомеченный пакет и если для него найдена содержащая метку запись в FIB, то пакет передается помеченным этой меткой (тем самым выполняется операция «push», в устоявшемся MPLS-домене эта операция выполняется только на граничном LSR);<br>
--&nbsp;если принят помеченный пакет и для него найдена содержащая ретрансляционную метку запись в FLIB, то осуществляется замена локальной метки на ретрансляционную (label swapping) и пакет передается помеченным новой меткой;<br>
--&nbsp;если принят помеченный пакет и для него найдена запись в FLIB, подразумевающая операцию «pop», то метка из пакета изымается и пакет передается на уровень FIB.<br>
В остальных ситуациях принятый пакет уничтожается.</p>

<p>Таким образом, метки имеют локальную значимость и валидны только в пределах сегментов.</p>

<p>После генерации локальной метки она, кроме всего прочего, заносится в FLIB, предполагающую замену меток, и с ней ассоциируется операция «pop» (операция по умолчанию), что и сохраняется вплоть до получения ретрансляционной метки. При таком подходе гарантируется, что MPLS-конвергенция, в отличие от конвергенции при динамической маршрутизации, не приводит к потере работоспособности MPLS-домена.</p>

<div align="center">
<img src="lk08.04.bmp">
<br>
Рисунок -- Пример создания и использования LSP для пересылки пакета в подсеть 192.0.0.0/24
</div>

<p>Можно обратить внимание на то, что на граничном LSR, завершающем LSP, при обработке пакета требуется два обращения к разным таблицам. Следовательно, можно оптимизировать алгоритм. При модификации PHP (Penultimate Hop Popping) граничный LSR, завершающий LSP, передает специально зарезервированное значение ретрансляционной метки (3 -- LDP, 1 -- TDP) и операция «pop» происходит при предпоследней в пределах MPLS-домена ретрансляции. В режиме cell-mode MPLS PHP недоступен, так как пару VPI/VCI из ATM-ячейки удалить невозможно.</p>

<p>Некоторую проблему при использовании MPLS создает автоматическое суммирование маршрутов в пределах MPLS-домена. Оно приводит к ветвлениям LSPs и дополнительным обращениям к RT. В режиме cell-mode MPLS автоматическое суммирование маршрутов недопустимо.</p>

<p>Поскольку технология MPLS предполагает увеличение размера кадра, требуется обеспечивать правильное значение MTU, особенно если соседние маршрутизаторы соединены посредством коммутаторов.</p>

<p>Не смотря на то, что MPLS-реализации опираются на протоколы динамической маршрутизации, у них имеются и собственные механизмы защиты от зацикливания и других сбоев в СПД, например собственное поле TTL.</p>

<p>Стабильность MPLS-домена отслеживается за счет периодического обмена мультикаст-сообщениями (<span class="c">224.0.0.2</span>, <span class="c">FF02::2</span>).</p>

<p>Реакцией на следующие события должна быть повторная MPLS-конвергенция:<br>
--&nbsp;внесение FEC в RT;<br>
--&nbsp;удаление FEC из RT;<br>
--&nbsp;смена следующего в звене маршрутизатора для FEC.</p>

<p>Критерии классификации MPLS-алгоритмов:<br>
1.&nbsp;Способ генерации меток (label space, label allocation):<br>
--&nbsp;per-platform -- уникальная метка для каждого класса FEC в рамках LSR (frame-mode MPLS);<br>
--&nbsp;per-interface -- уникальная метка для каждого класса FEC в рамках сетевого интерфейса LSR (cell-mode MPLS).<br>
2.&nbsp;Способ распространения меток (label distribution):<br>
--&nbsp;unsolicited downstream -- асинхронное получение ретрансляционной метки от следующего в звене LSR (frame-mode MPLS);<br>
--&nbsp;downstream-on-demand -- запрос ретрансляционной метки у следующего в звене LSR (cell-mode MPLS).<br>
3.&nbsp;Способ контроля генерации меток (label allocation control):<br>
--&nbsp;independent -- LSRs генерируют метки независимо друг от друга (frame-mode MPLS);<br>
--&nbsp;ordered -- перед тем как распространять свои локальные метки LSRs уже должны иметь ретрансляционные метки (cell-mode MPLS).<br>
4.&nbsp;Способ удержания меток (label retention):<br>
--&nbsp;liberal -- на LSR удерживаются все полученные метки (frame-mode MPLS);<br>
--&nbsp;conservative -- на LSR удерживаются только запрошенные метки (cell-mode MPLS).</p>

<p>В настоящее время активно ведется разработка MPLSv6. Появилось дополнение к RFC&nbsp;5036 -- RFC&nbsp;7552.</p>

</div>

</BODY>
</HTML>
